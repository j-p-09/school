<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <title>Redovalnica</title>
  <style>
.dialog-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

.dialog-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
}

.vnos-kvadrat {
  background-color: #eee;
  width: 40px;
  height: 40px;
  font-size: 18px;
  text-align: center;
  border: none;
  border-radius: 6px;
  box-shadow: inset 0 0 2px #aaa;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #aaa;
  padding: 10px;
  text-align: center;
}
th img {
  height: 20px;
}
.pisna { color: red; font-weight: bold; }
.ustna { color: blue; font-weight: bold; }
.izdelek { color: purple; font-weight: bold; }
.ocena-box {
  display: inline-block;
  font-weight: bold;
  margin: 0 4px;
  padding: 4px 8px;
  border-radius: 5px;
  background: #eee;
  cursor: pointer;
}
.popravek {
  font-size: 0.75em;
  opacity: 0.8;
  background: #ccc;
}
.dialog {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 350px;
  max-width: 90vw;
  position: relative;
}
.close-btn {
  position: absolute;
  top: 8px;
  right: 12px;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  user-select: none;
}
  </style>
</head>
<body>

<h2>Redovalnica</h2>

<table id="redovalnica">
  <thead>
    <tr>
      <th>Predmet</th>
      <th>A</th>
      <th><img src="graja.png" alt="XK" /></th>
      <th>B</th>
      <th><img src="graja.png" alt="XK" /></th>
      <th>Konec</th>
    </tr>
  </thead>
  <tbody>
    <!-- Avtomatsko nastavimo data-row, da ne pride do napak -->
    <tr><td>A1</td><td class="editable ocenaste" data-row="0" data-col="1"></td><td class="editable xk" data-row="0" data-col="2"></td><td class="editable ocenaste" data-row="0" data-col="3"></td><td class="editable xk" data-row="0" data-col="4"></td><td></td></tr>
    <tr><td>A2</td><td class="editable ocenaste" data-row="1" data-col="1"></td><td class="editable xk" data-row="1" data-col="2"></td><td class="editable ocenaste" data-row="1" data-col="3"></td><td class="editable xk" data-row="1" data-col="4"></td><td></td></tr>
    <tr><td>A3</td><td class="editable ocenaste" data-row="2" data-col="1"></td><td class="editable xk" data-row="2" data-col="2"></td><td class="editable ocenaste" data-row="2" data-col="3"></td><td class="editable xk" data-row="2" data-col="4"></td><td></td></tr>
    <tr><td>A4</td><td class="editable ocenaste" data-row="3" data-col="1"></td><td class="editable xk" data-row="3" data-col="2"></td><td class="editable ocenaste" data-row="3" data-col="3"></td><td class="editable xk" data-row="3" data-col="4"></td><td></td></tr>
    <tr><td>A5</td><td class="editable ocenaste" data-row="4" data-col="1"></td><td class="editable xk" data-row="4" data-col="2"></td><td class="editable ocenaste" data-row="4" data-col="3"></td><td class="editable xk" data-row="4" data-col="4"></td><td></td></tr>
  </tbody>
</table>

<div id="dialog-container" class="dialog-container"></div>

<script>
// --- PODATKI --- //
let oceneData = JSON.parse(localStorage.getItem("oceneData") || "{}");
const dialogContainer = document.getElementById('dialog-container');

function saveData() {
  localStorage.setItem("oceneData", JSON.stringify(oceneData));
}

// --- POMOŽNE FUNKCIJE --- //
function closeDialog() {
  dialogContainer.style.display = 'none';
  dialogContainer.innerHTML = '';
}

function openOcenaDialog(cell) {
  dialogContainer.style.display = 'flex';
  const row = cell.dataset.row, col = cell.dataset.col;
  dialogContainer.innerHTML = `
    <div class="dialog-overlay" onclick="closeDialog()">
      <div class="dialog" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeDialog()">✖</span>
        <h3>Upravljanje ocen</h3>
        <button onclick="showVnosForm(${row}, ${col})">VPIŠI OCENO</button>
        <button onclick="urediObstojece(${row}, ${col})">UREDI OBSTOJEČE OCENE</button>
      </div>
    </div>
  `;
}

function showVnosForm(row, col) {
  dialogContainer.innerHTML = `
    <div class="dialog-overlay" onclick="closeDialog()">
      <div class="dialog" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeDialog()">✖</span>
        <h3>Vpiši oceno</h3>
        <label><input type="radio" name="tip" value="pisna" /> <span class="pisna">PISNA</span></label><br>
        <label><input type="radio" name="tip" value="ustna" /> <span class="ustna">USTNA</span></label><br>
        <label><input type="radio" name="tip" value="izdelek" /> <span class="izdelek">IZDELEK</span></label><br><br>
        <input type="text" id="vnos-ocena" class="vnos-kvadrat" placeholder="Ocena" maxlength="2" /><br><br>
        <textarea id="vnos-opombe" rows="3" placeholder="Opombe"></textarea><br><br>
        <button onclick="shraniOceno(${row}, ${col})">Shrani</button>
      </div>
    </div>
  `;
}

function shraniOceno(row, col) {
  const tip = document.querySelector('input[name="tip"]:checked')?.value;
  const vrednost = document.getElementById('vnos-ocena').value.trim();
  const opombe = document.getElementById('vnos-opombe').value.trim();
  const key = `${row}_${col}`;

  if (!tip || !vrednost) {
    alert('Izpolni vse podatke!');
    return;
  }

  const novaOcena = {
    tip, ocena: vrednost, opombe,
    datum: new Date().toLocaleDateString(),
    popravek: []
  };

  if (!oceneData[key]) oceneData[key] = [];
  oceneData[key].push(novaOcena);
  saveData();
  prikaziOcene(row, col);
  closeDialog();
}

function prikaziOcene(row, col) {
  const key = `${row}_${col}`;
  const td = document.querySelector(`#redovalnica tbody tr:nth-child(${parseInt(row)+1})`).children[col];
  td.innerHTML = '';

  if (!oceneData[key]) return;

  oceneData[key].forEach((oc, i) => {
    const mainSpan = document.createElement('span');
    mainSpan.className = `ocena-box ${oc.tip}`;
    mainSpan.title = `Opombe: ${oc.opombe || '-'}\nDatum: ${oc.datum}`;
    mainSpan.innerText = oc.ocena;
    mainSpan.onclick = () => urediPosameznoOceno(row, col, i);
    td.appendChild(mainSpan);

    oc.popravek.forEach(pop => {
      const popSpan = document.createElement('span');
      popSpan.className = `ocena-box ${oc.tip} popravek`;
      popSpan.title = `Komentar: ${pop.komentar || '-'}\nDatum: ${pop.datum}`;
      popSpan.innerText = pop.ocena;
      td.appendChild(popSpan);
    });
  });
}

function urediObstojece(row, col) {
  const key = `${row}_${col}`;
  const ocene = oceneData[key] || [];

  let html = '<h3>Obstoječe ocene</h3>';
  if (ocene.length === 0) {
    html += '<p>Ni vpisanih ocen.</p>';
  } else {
    ocene.forEach((oc, i) => {
      html += `
        <div class="ocena-box ${oc.tip}" style="margin:5px 0;" onclick="urediPosameznoOceno(${row}, ${col}, ${i})">
          ${oc.ocena} (${oc.datum})
        </div>
      `;
    });
  }

  dialogContainer.innerHTML = `
    <div class="dialog-overlay" onclick="closeDialog()">
      <div class="dialog" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeDialog()">✖</span>
        ${html}
      </div>
    </div>
  `;
}

function urediPosameznoOceno(row, col, index) {
  const key = `${row}_${col}`;
  const oc = oceneData[key][index];

  let popravkiHtml = oc.popravek.map(p => `<div class="popravek">${p.ocena} (${p.komentar || ''})</div>`).join('');

  dialogContainer.innerHTML = `
    <div class="dialog-overlay" onclick="closeDialog()">
      <div class="dialog" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeDialog()">✖</span>
        <h3>Trenutna ocena</h3>
        <div class="ocena-box ${oc.tip}">${oc.ocena}</div>
        <h4>Popravki:</h4>${popravkiHtml}
        <h4>Dodaj popravek</h4>
        <input type="text" id="nova-popravna" placeholder="Nova ocena" />
        <textarea id="komentar-popravka" placeholder="Komentar"></textarea><br>
        <button onclick="shraniPopravek(${row}, ${col}, ${index})">Shrani</button>
      </div>
    </div>
  `;
}

function shraniPopravek(row, col, index) {
  const nova = document.getElementById('nova-popravna').value.trim();
  const komentar = document.getElementById('komentar-popravka').value.trim();
  if (!nova) {
    alert('Vpiši novo oceno!');
    return;
  }
  oceneData[`${row}_${col}`][index].popravek.push({
    ocena: nova,
    komentar,
    datum: new Date().toLocaleDateString()
  });
  saveData();
  prikaziOcene(row, col);
  closeDialog();
}

// --- ZAČETEK --- //
document.querySelectorAll('#redovalnica tbody tr').forEach(tr => {
  tr.querySelectorAll('td.editable').forEach(td => {
    td.addEventListener('click', () => {
      if (td.classList.contains('ocenaste')) {
        openOcenaDialog(td);
      }
    });
  });
});

// Ob zagonu naložimo shranjene ocene:
for (const key in oceneData) {
  const [row, col] = key.split('_').map(Number);
  prikaziOcene(row, col);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <title>Redovalnica</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #login { max-width: 300px; margin: auto; }
    #app { display: none; }
    .toolbar { display: flex; gap: 10px; margin-bottom: 10px; }
    select, button { padding: 5px; }
    .active-view { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td, th { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .grade-input { width: 30px; background-color: #eee; border: none; }
    .unsaved { background-color: #c5f3c5; }
    .saved { transition: background-color 1s ease; }
    .modal { display: none; position: fixed; top: 50%; left: 50%; 
             transform: translate(-50%, -50%); background: white; 
             padding: 20px; box-shadow: 0 0 10px black; }
    .modal.active { display: block; }
    .grade-type-btn { font-weight: bold; padding: 5px 10px; }
    .grade-pisna { color: red; }
    .grade-ustna { color: blue; }
    .grade-izdelek { color: green; }
  </style>
</head>
<body>

<div id="login">
  <h2>Prijava</h2>
  <input id="username" placeholder="Uporabniško ime">
  <button onclick="login()">Prijava</button>
  <div id="login-error" style="color: red;"></div>
</div>

<div id="app">
  <div class="toolbar">
    <button onclick="switchView('predmetni')" id="btn-predmetni">Predmetni</button>
    <button onclick="switchView('osebni')" id="btn-osebni">Osebni</button>
    <select id="selector" onchange="renderTable()"></select>

    <button class="grade-type-btn grade-pisna" onclick="setGradeType('pisna')">PISNA</button>
    <button class="grade-type-btn grade-ustna" onclick="setGradeType('ustna')">USTNA</button>
    <button class="grade-type-btn grade-izdelek" onclick="setGradeType('izdelek')">IZDELEK</button>
  </div>

  <div id="table-container"></div>
</div>

<div class="modal" id="modal">
  <label>Opomba: <input id="note" style="width: 100%;"></label><br><br>
  <button onclick="saveGrade()">Shrani oceno</button>
</div>

<script>
  let currentView = 'predmetni';
  let currentType = 'pisna';
  let selected = '';
  let currentGradeCell = null;
  const predmetList = ['Matematika', 'Slovenščina', 'Zgodovina'];
  const dijaki = ['Ana Novak', 'Miha Kralj', 'Luka Zupan'];

  const oceneData = JSON.parse(localStorage.getItem('oceneData')) || {};

  function login() {
    const user = document.getElementById('username').value;
    if (user === 'jp09') {
      document.getElementById('login').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      populateSelector();
      renderTable(); // Tabela se takoj prikaže po prijavi
    } else {
      document.getElementById('login-error').textContent = 'Nepravilno uporabniško ime';
    }
  }

  function switchView(view) {
    currentView = view;
    document.getElementById('btn-predmetni').classList.toggle('active-view', view === 'predmetni');
    document.getElementById('btn-osebni').classList.toggle('active-view', view === 'osebni');
    populateSelector();
    renderTable(); // <-- Tabela se osveži takoj ob preklopu pogleda
  }

  function populateSelector() {
    const sel = document.getElementById('selector');
    sel.innerHTML = '';
    const list = currentView === 'predmetni' ? predmetList : dijaki;
    list.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      sel.appendChild(opt);
    });
    selected = list[0];
  }

  function setGradeType(type) {
    currentType = type;
  }

  function renderTable() {
    selected = document.getElementById('selector').value;
    const container = document.getElementById('table-container');
    let html = '<table><tr><th>' + (currentView === 'predmetni' ? 'Dijak' : 'Predmet') +
               '</th><th>Prvo obdobje</th><th>Drugo obdobje</th><th>Konec</th></tr>';

    const list = currentView === 'predmetni' ? dijaki : predmetList;

    list.forEach(entry => {
      html += `<tr><td>${entry}</td>`;
      ['1', '2'].forEach(period => {
        const id = currentView === 'predmetni' ? `${entry}_${selected}_${period}` : `${selected}_${entry}_${period}`;
        const grade = oceneData[id]?.grade || '';
        const type = oceneData[id]?.type || '';
        const colorClass = type ? `grade-${type}` : '';
        html += `<td><input class="grade-input ${colorClass}" data-id="${id}" value="${grade}" onkeydown="handleKey(event, this)"></td>`;
      });
      html += '<td></td></tr>';
    });

    html += '</table>';
    container.innerHTML = html;
  }

  function handleKey(e, input) {
    if (e.key === 'Enter') {
      currentGradeCell = input;
      document.getElementById('note').value = '';
      document.getElementById('modal').classList.add('active');
    }
  }

  function saveGrade() {
    const id = currentGradeCell.dataset.id;
    const grade = currentGradeCell.value;
    const note = document.getElementById('note').value;
    oceneData[id] = { grade, note, type: currentType };
    localStorage.setItem('oceneData', JSON.stringify(oceneData));

    currentGradeCell.classList.add(`grade-${currentType}`);
    currentGradeCell.classList.add('unsaved');

    setTimeout(() => {
      currentGradeCell.classList.remove('unsaved');
    }, 2000);

    document.getElementById('modal').classList.remove('active');
  }
</script>

</body>
</html>

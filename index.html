<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Urejanje ocen s popravljanjem</title>
<style>
  table { border-collapse: collapse; width: 100%; max-width: 600px; margin: auto; }
  th, td { border: 1px solid #999; padding: 8px; text-align: center; }
  th { background: #eee; }
  td.konec { cursor: pointer; font-weight: normal; font-size: 1em; color: gray; }
  td.ocena { cursor: pointer; }
  .vnos-kvadrat { width: 40px; font-size: 1.2em; text-align: center; }
  /* Modal styling */
  .dialog-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
  }
  .dialog {
    background: white; padding: 20px; border-radius: 6px;
    max-width: 400px; width: 90%;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
  }
  .close-btn {
    position: absolute; top: 10px; right: 15px; cursor: pointer;
    font-weight: bold; font-size: 18px;
  }
  textarea {
    width: 100%; height: 80px; resize: vertical; font-size: 1em; padding: 6px;
  }
  button {
    margin: 5px 5px 5px 0; padding: 6px 10px; cursor: pointer;
  }
  ul {
    margin: 0; padding-left: 20px; max-height: 100px; overflow-y: auto;
  }
</style>
</head>
<body>

<table>
  <thead>
    <tr><th>Študent</th><th>A</th><th>B</th><th>Konec</th></tr>
  </thead>
  <tbody>
    <tr>
      <td>Janez Novak</td>
      <td class="ocena" data-row="0" data-col="A"></td>
      <td class="ocena" data-row="0" data-col="B"></td>
      <td class="konec" data-row="0"></td>
    </tr>
    <tr>
      <td>Maja Kovač</td>
      <td class="ocena" data-row="1" data-col="A"></td>
      <td class="ocena" data-row="1" data-col="B"></td>
      <td class="konec" data-row="1"></td>
    </tr>
    <tr>
      <td>Alen Zupan</td>
      <td class="ocena" data-row="2" data-col="A"></td>
      <td class="ocena" data-row="2" data-col="B"></td>
      <td class="konec" data-row="2"></td>
    </tr>
  </tbody>
</table>

<div id="dialogContainer"></div>

<script>
  const dialogContainer = document.getElementById('dialogContainer');

  // Shrani ocene: objekt s ključi "row_col" in vrednostmi: array ocenaObjektov
  // ocenaObjekt: { ocena: '3', opombe: '...', popravek: [{ ocena:'4', opombe:'...'}, ...] }
  let oceneData = {};

  // Pomočna: validiraj oceno (1,2,3,4,5,N)
  function validirajOceno(v) {
    return ['1','2','3','4','5','N'].includes(v.toUpperCase());
  }

  // Prikaz ocen v celici (A ali B)
  function prikaziOcene(row, col) {
    const key = `${row}_${col}`;
    const td = document.querySelector(`td.ocena[data-row="${row}"][data-col="${col}"]`);
    if(!td) return;

    const ocene = oceneData[key] || [];
    if(ocene.length === 0) {
      td.textContent = '';
      return;
    }
    // Pokažemo vse ocene kot npr: 3 (z možnostjo urejanja ob kliku)
    td.innerHTML = '';
    ocene.forEach((o, i) => {
      const span = document.createElement('span');
      span.textContent = o.ocena;
      span.style.cursor = 'pointer';
      span.style.marginRight = '8px';
      span.title = 'Klikni za urejanje ocene in popravek/opombe';
      span.onclick = () => { urediPosameznoOceno(row, col, i); };
      td.appendChild(span);
    });
  }

  // Ob kliku na celico A ali B odpremo vnosno pogovorno okno (tvoje obstoječe)
  document.querySelectorAll('td.ocena').forEach(td=>{
    td.addEventListener('click', e=>{
      const row = parseInt(td.getAttribute('data-row'));
      const col = td.getAttribute('data-col');
      odpriVnosnoOkno(row, col);
    });
  });

  // --- Obstoječe vnosno okno (kot prej), samo da lahko dodajamo nove ocene v array ---
  function odpriVnosnoOkno(row, col) {
    dialogContainer.innerHTML = `
      <div class="dialog-overlay" onclick="closeDialog()">
        <div class="dialog" onclick="event.stopPropagation()">
          <span class="close-btn" onclick="closeDialog()">✖</span>
          <h3>Vpiši oceno za ${col}</h3>
          <label>Ocena (1,2,3,4,5 ali N):<br>
            <input type="text" id="vnosOcena" maxlength="1" class="vnos-kvadrat" />
          </label><br><br>
          <label>Opombe:<br>
            <textarea id="vnosOpombe" rows="3"></textarea>
          </label><br><br>
          <button onclick="shraniNovoOceno(${row}, '${col}')">Shrani oceno</button>
          <button onclick="closeDialog()">Prekliči</button>
        </div>
      </div>
    `;
  }

  // Shrani novo oceno v array za (row_col)
  function shraniNovoOceno(row, col) {
    const ocena = document.getElementById('vnosOcena').value.trim().toUpperCase();
    const opombe = document.getElementById('vnosOpombe').value.trim();
    if(!validirajOceno(ocena)) {
      alert('Ocena mora biti 1,2,3,4,5 ali N!');
      return;
    }
    const key = `${row}_${col}`;
    if(!oceneData[key]) oceneData[key] = [];
    oceneData[key].push({ ocena, opombe, popravek: [] });
    prikaziOcene(row, col);
    izracunajZakljucno(row);
    saveData();
    closeDialog();
  }

  // Zapri dialog
  function closeDialog() {
    dialogContainer.innerHTML = '';
  }

  // --- Modal za urejanje posamezne ocene s popravljanjem, opombami, brisanjem ---

  function urediPosameznoOceno(row, col, index) {
    const key = `${row}_${col}`;
    const ocenaObj = oceneData[key][index];
    if(!ocenaObj) return;

    const popravek = ocenaObj.popravek || [];

    let popravekHtml = '';
    if(popravek.length === 0) {
      popravekHtml = '<p>Ni popravljanj</p>';
    } else {
      popravekHtml = '<ul>';
      popravek.forEach((p, i) => {
        popravekHtml += `<li>
          Ocena: <input type="text" class="vnos-kvadrat popravek-ocena" data-idx="${i}" value="${p.ocena}" maxlength="1" />
          <button onclick="urediOpombePopravka(${row}, '${col}', ${index}, ${i})">Opombe</button>
          <button onclick="izbrisiPopravek(${row}, '${col}', ${index}, ${i})">Izbriši</button>
        </li>`;
      });
      popravekHtml += '</ul>';
    }

    dialogContainer.innerHTML = `
      <div class="dialog-overlay" onclick="closeDialog()">
        <div class="dialog" onclick="event.stopPropagation()">
          <span class="close-btn" onclick="closeDialog()">✖</span>
          <h3>Uredi oceno za ${col}</h3>
          <label>Trenutna ocena:<br>
            <input type="text" id="trenutnaOcenaInput" class="vnos-kvadrat" maxlength="1" value="${ocenaObj.ocena}" />
            <button onclick="urediOpombe('trenutna', ${row}, '${col}', ${index})">Opombe</button>
          </label>
          <hr>
          <label>Popravljeno z:<br>
            <input type="text" id="novaPoprOcena" class="vnos-kvadrat" maxlength="1" />
            <button onclick="urediOpombe('nova', ${row}, '${col}', ${index})">Opombe</button>
            <button onclick="dodajPopravek(${row}, '${col}', ${index})">Dodaj popravek</button>
          </label>
          <hr>
          <div id="popravkiLista">${popravekHtml}</div>
          <hr>
          <button onclick="shraniUrejanjeOcene(${row}, '${col}', ${index})">Shrani</button>
          <button onclick="izbrisiOceno(${row}, '${col}', ${index})" style="background:#f44;color:#fff;">Izbriši oceno</button>
          <button onclick="closeDialog()">Prekliči</button>
        </div>
      </div>
    `;
  }

  // Uredi opombe (trenutna, nova, popravek)
  function urediOpombe(tip, row, col, index, i) {
    let tekstOpombe = '';
    let naslov = '';

    if(tip === 'trenutna') {
      tekstOpombe = oceneData[`${row}_${col}`][index].opombe || '';
      naslov = 'Opombe glavne ocene';
    } else if(tip === 'nova') {
      tekstOpombe = novaPopravekOpombe || '';
      naslov = 'Opombe novega popravka';
    } else if(tip === 'popravek') {
      tekstOpombe = oceneData[`${row}_${col}`][index].popravek[i].opombe || '';
      naslov = 'Opombe popravka';
    }

    dialogContainer.innerHTML = `
      <div class="dialog-overlay" onclick="closeDialog()">
        <div class="dialog" onclick="event.stopPropagation()">
          <span class="close-btn" onclick="closeDialog()">✖</span>
          <h3>${naslov}</h3>
          <textarea id="textareaOpombe">${tekstOpombe}</textarea><br><br>
          <button onclick="shraniOpombe('${tip}', ${row}, '${col}', ${index}, ${i || 0})">Shrani</button>
          <button onclick="closeDialog()">Prekliči</button>
        </div>
      </div>
    `;
  }

  // Shrani opombe
  function shraniOpombe(tip, row, col, index, i) {
    const tekst = document.getElementById('textareaOpombe').value.trim();

    if(tip === 'trenutna') {
      oceneData[`${row}_${col}`][index].opombe = tekst;
    } else if(tip === 'nova') {
      novaPopravekOpombe = tekst;
    } else if(tip === 'popravek') {
      oceneData[`${row}_${col}`][index].popravek[i].opombe = tekst;
    }
    closeDialog();
  }

  let novaPopravekOpombe = '';

  // Dodaj popravek
  function dodajPopravek(row, col, index) {
    const novaOcena = document.getElementById('novaPoprOcena').value.trim().toUpperCase();
    if(!validirajOceno(novaOcena)) {
      alert('Ocena mora biti 1,2,3,4,5 ali N');
      return;
    }
    if(!oceneData[`${row}_${col}`][index].popravek) oceneData[`${row}_${col}`][index].popravek = [];
    oceneData[`${row}_${col}`][index].popravek.push({
      ocena: novaOcena,
      opombe: novaPopravekOpombe || ''
    });
    novaPopravekOpombe = '';
    urediPosameznoOceno(row, col, index);
  }

  // Izbriši popravek
  function izbrisiPopravek(row, col, index, i) {
    if(confirm('Res želite izbrisati ta popravek?')) {
      oceneData[`${row}_${col}`][index].popravek.splice(i,1);
      urediPosameznoOceno(row, col, index);
    }
  }

  // Shrani urejanje ocene
  function shraniUrejanjeOcene(row, col, index) {
    const novaGlavnaOcena = document.getElementById('trenutnaOcenaInput').value.trim().toUpperCase();
    if(!validirajOceno(novaGlavnaOcena)) {
      alert('Ocena mora biti 1,2,3,4,5 ali N');
      return;
    }
    oceneData[`${row}_${col}`][index].ocena = novaGlavnaOcena;
    prikaziOcene(row, col);
    izracunajZakljucno(row);
    saveData();
    closeDialog();
  }

  // Izbriši oceno
  function izbrisiOceno(row, col, index) {
    if(confirm('Res želite izbrisati to oceno?')) {
      oceneData[`${row}_${col}`].splice(index,1);
      prikaziOcene(row, col);
      izracunajZakljucno(row);
      saveData();
      closeDialog();
    }
  }

  // --- Izračun končne ocene v stolpcu "konec" ---

  function izracunajZakljucno(row) {
    // Za vse stolpce A in B
    const stCols = ['A','B'];
    let vseOcene = [];
    stCols.forEach(col=>{
      const key = `${row}_${col}`;
      if(oceneData[key]) {
        oceneData[key].forEach(o=>{
          // Glavna ocena + popravki
          vseOcene.push(o.ocena);
          if(o.popravek) {
            o.popravek.forEach(p=> vseOcene.push(p.ocena));
          }
        });
      }
    });

    // Pretvori ocene: N = 0, ostale številčne
    let vrednosti = vseOcene.map(o => o === 'N' ? 0 : parseInt(o)).filter(n => !isNaN(n));
    if(vrednosti.length === 0) {
      // Če ni ocen, prazno
      const celicaKonec = document.querySelector(`td.konec[data-row="${row}"]`);
      if(celicaKonec) celicaKonec.textContent = '';
      return;
    }
    // Končna ocena = max ocena
    const maxOcena = Math.max(...vrednosti);

    const celicaKonec = document.querySelector(`td.konec[data-row="${row}"]`);
    if(celicaKonec) celicaKonec.textContent = maxOcena === 0 ? 'N' : maxOcena;
  }

  // --- Shrani/Preberi iz localStorage ---

  function saveData() {
    localStorage.setItem('oceneData', JSON.stringify(oceneData));
  }

  function loadData() {
    const data = localStorage.getItem('oceneData');
    if(data) {
      oceneData = JSON.parse(data);
      // Osveži prikaz vseh ocen in izračun končne
      for(let row=0; row<3; row++) {
        ['A','B'].forEach(col=>{
          prikaziOcene(row,col);
        });
        izracunajZakljucno(row);
      }
    }
  }

  // Ob nalaganju strani naloži podatke
  loadData();
</script>

</body>
</html>
